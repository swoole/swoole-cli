name: build-swoole-cli

on: [push, pull_request]

jobs:
  linux:
    if: 0
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: configure
      run: |
        git submodule update --init
        SKIP_LIBRARY_DOWNLOAD=1 php prepare.php +mongodb +inotify
        chmod +x ./make.sh
    - name: build
      uses: addnab/docker-run-action@v3
      with:
        image: phpswoole/swoole_cli_os:1.4
        options: -v ${{ github.workspace }}:/work
        run: |
          cd /work
          ./make.sh config
          ./make.sh build
  cygwin:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v3
    - name: install deps
      uses: cygwin/cygwin-install-action@v2
      with:
        platform: x64
        packages: wget tar php php-devel gcc-g++ openssl libpcre2-devellibssl-devel libcurl-devel libxml2-devel libxslt-devel libgmp-devel ImageMagick libpng-devel libjpeg-devel libfreetype-devel libwebp-devel libsqlite3-devel zlib-devel libbz2-devel libzip2-devel libicu-devel libonig-devel libcares-devel libsodium-devel libyaml-devel libMagick-devel 
    - name: configure
      run: |
        git submodule update --init
        SKIP_LIBRARY_DOWNLOAD=1 php prepare.php +mongodb
        chmod +x ./make.sh
        ./configure --prefix=/usr --disable-all \
          --disable-fiber-asm \
          --disable-opcache \
          --without-pcre-jit \
          --with-openssl --enable-openssl \
          --with-curl \
          --with-iconv \
          --enable-intl \
          --with-bz2 \
          --enable-bcmath \
          --enable-filter \
          --enable-session \
          --enable-tokenizer \
          --enable-mbstring \
          --enable-ctype \
          --with-zlib \
          --with-zip \
          --enable-posix \
          --enable-sockets \
          --enable-pdo \
          --with-sqlite3 \
          --enable-phar \
          --enable-pcntl \
          --enable-mysqlnd \
          --with-mysqli \
          --enable-fileinfo \
          --with-pdo_mysql \
          --with-pdo-sqlite \
          --enable-soap \
          --with-xsl \
          --with-gmp \
          --enable-exif \
          --with-sodium \
          --enable-xml --enable-simplexml --enable-xmlreader --enable-xmlwriter --enable-dom --with-libxml \
          --enable-gd --with-jpeg  --with-freetype \
          --enable-swoole --enable-sockets --enable-mysqlnd --enable-swoole-curl --enable-cares \
          --enable-redis \
          --with-imagick \
          --with-yaml 
          --enable-mongodb
    - name: build
      run: | 
        make -j$(nproc)
        ./bin/swoole-cli -v
